
---
title: "Association Between Vitamin D Levels and Depression Among U.S. Adults: NHANES 2021-2023"
author: "Bisrat Bekele"
date: "2025-11-29"
output: html_document
---


# 1. Install packages and open libraries

```{r}
# Install pacman if not already installed
if (!require("pacman")) install.packages("pacman")

# Load necessary packages
pacman::p_load(
  ggplot2,        
  car,            
  odds.n.ends,    
  dplyr,          
  tidyr,          
  haven,          
  table1          
)
```

# 2. Import NHANES 2021-2023 Data

```{r}

github_base <- "https://raw.githubusercontent.com/Bisratbekele/ADA-Final-Assignment/master/ADA%20Final/"

DEMO_L <- read_xpt(paste0(github_base, "DEMO_L.xpt"))
VID_L  <- read_xpt(paste0(github_base, "VID_L.xpt"))
DPQ_L  <- read_xpt(paste0(github_base, "DPQ_L.xpt"))
BMX_L  <- read_xpt(paste0(github_base, "BMX_L.xpt"))
SMQ_L  <- read_xpt(paste0(github_base, "SMQ_L.xpt"))

cat("DEMO_L dimensions:", dim(DEMO_L), "\n")
cat("VID_L dimensions:",  dim(VID_L),  "\n")
cat("DPQ_L dimensions:",  dim(DPQ_L),  "\n")
cat("BMX_L dimensions:",  dim(BMX_L),  "\n")
cat("SMQ_L dimensions:",  dim(SMQ_L),  "\n")
```

# 3. Data Management 

## 3a. Merge datasets by SEQN

```{r}

nhanes_data <- DEMO_L %>%
  left_join(VID_L, by = "SEQN") %>%
  left_join(DPQ_L, by = "SEQN") %>%
  left_join(BMX_L, by = "SEQN") %>%
  left_join(SMQ_L, by = "SEQN")

# Check merged 
cat("Merged dataset dimensions:", dim(nhanes_data), "\n")
```

## 3b. Create PHQ-9 depression score 

```{r}

nhanes_data <- nhanes_data %>%
  mutate(
    # Sum PHQ-9 items (DPQ010 - DPQ090)
    phq9_total = rowSums(select(., starts_with("DPQ0")), na.rm = FALSE),
    
    # Create binary depression variable (PHQ-9 ≥ 10 = moderate to severe depression)
    depression_binary = case_when(
      phq9_total >= 10 ~ 1,
      phq9_total < 10 ~ 0
    )
  )

# Convert to factor
nhanes_data$depression_binary <- factor(
  nhanes_data$depression_binary, 
  levels = c(0, 1), 
  labels = c("No Depression", "Depression")
)

# Check distribution
table(nhanes_data$depression_binary, useNA = "always")
```

## 3c. Create Vitamin D categorical variable

```{r}
# Categorical Total Vitamin D variable based on clinical cutoffs
# Deficient: <50 nmol/L
# Insufficient: 50-74 nmol/L  
# Sufficient: ≥75 nmol/L

nhanes_data <- nhanes_data %>%
  mutate(
    vitd_category = case_when(
      LBXVIDMS < 50 ~ "Deficient",
      LBXVIDMS >= 50 & LBXVIDMS < 75 ~ "Insufficient",
      LBXVIDMS >= 75 ~ "Sufficient"
    )
  )

# Convert to factor 
nhanes_data$vitd_category <- factor(
  nhanes_data$vitd_category,
  levels = c("Sufficient", "Insufficient", "Deficient")
)

# Check distribution
table(nhanes_data$vitd_category, useNA = "always")
```

## 3d. Recode demographic and health variables

```{r}
nhanes_data <- nhanes_data %>%
  mutate(
    # Age groups
    age_cat = case_when(
      RIDAGEYR >= 18 & RIDAGEYR < 30 ~ "18-29",
      RIDAGEYR >= 30 & RIDAGEYR < 40 ~ "30-39",
      RIDAGEYR >= 40 & RIDAGEYR < 50 ~ "40-49",
      RIDAGEYR >= 50 & RIDAGEYR < 60 ~ "50-59",
      RIDAGEYR >= 60 & RIDAGEYR < 70 ~ "60-69",
      RIDAGEYR >= 70 ~ "70+"
    ),
    
    # Sex (RIAGENDR: 1=Male, 2=Female)
    sex = case_when(
      RIAGENDR == 1 ~ "Male",
      RIAGENDR == 2 ~ "Female"
    ),
    
    # Race/Ethnicity (RIDRETH3)
    race_ethnicity = case_when(
      RIDRETH3 == 1 ~ "Mexican American",
      RIDRETH3 == 2 ~ "Other Hispanic",
      RIDRETH3 == 3 ~ "Non-Hispanic White",
      RIDRETH3 == 4 ~ "Non-Hispanic Black",
      RIDRETH3 == 6 ~ "Non-Hispanic Asian",
      RIDRETH3 == 7 ~ "Other/Multiracial"
    ),
    
    # Education (DMDEDUC2: for adults 20+)
    education = case_when(
      DMDEDUC2 == 1 ~ "Less than 9th grade",
      DMDEDUC2 == 2 ~ "9-11th grade",
      DMDEDUC2 == 3 ~ "High school/GED",
      DMDEDUC2 == 4 ~ "Some college/AA",
      DMDEDUC2 == 5 ~ "College graduate or above"
    ),
    
    # Smoking status (SMQ020: Have you smoked at least 100 cigarettes?)
    smoking_status = case_when(
      SMQ020 == 1 ~ "Ever smoker",
      SMQ020 == 2 ~ "Never smoker"
    )
  )

# Convert categorical variables to factors
nhanes_data$age_cat <- factor(nhanes_data$age_cat, 
                              levels = c("18-29", "30-39", "40-49", "50-59", "60-69", "70+"))
nhanes_data$sex <- factor(nhanes_data$sex, levels = c("Male", "Female"))
nhanes_data$race_ethnicity <- factor(nhanes_data$race_ethnicity)
nhanes_data$education <- factor(nhanes_data$education,
                                levels = c("Less than 9th grade", "9-11th grade", 
                                          "High school/GED", "Some college/AA", 
                                          "College graduate or above"))
nhanes_data$smoking_status <- factor(nhanes_data$smoking_status,
                                    levels = c("Never smoker", "Ever smoker"))
```

## 3e. Select variables for analysis

```{r}
# variables needed for this analysis
analysis_data <- nhanes_data %>%
  select(
    SEQN,                    # Participant ID
    LBXVIDMS,                # Serum Vitamin D (continuous)
    vitd_category,           # Vitamin D categories
    phq9_total,              # PHQ-9 total score
    depression_binary,       # Depression outcome
    RIDAGEYR,                # Age (continuous)
    age_cat,                 # Age categories
    sex,                     # Sex
    race_ethnicity,          # Race/Ethnicity
    BMXBMI,                  # BMI
    education,               # Education
    INDFMPIR,                # Poverty Income Ratio
    smoking_status           # Smoking status
  )
glimpse(analysis_data)
```

# 4. Examine variables for missing data

```{r}
# Examine categorical variables
table(analysis_data$depression_binary, useNA = "always")
table(analysis_data$vitd_category, useNA = "always")
table(analysis_data$sex, useNA = "always")
table(analysis_data$age_cat, useNA = "always")
table(analysis_data$race_ethnicity, useNA = "always")
table(analysis_data$education, useNA = "always")
table(analysis_data$smoking_status, useNA = "always")

# Examine continuous variables
summary(analysis_data$LBXVIDMS)      # Vitamin D
summary(analysis_data$RIDAGEYR)      # Age
summary(analysis_data$BMXBMI)        # BMI
summary(analysis_data$phq9_total)    # PHQ-9 score
summary(analysis_data$INDFMPIR)      # Income-to-poverty ratio
```

# 5. Check classification of depression variable

```{r}

table(analysis_data$depression_binary, 
      analysis_data$phq9_total >= 10, 
      useNA = "always")
```

# 6. Descriptive visualization: Vitamin D levels by depression status

```{r}
# Box plot: Vitamin D levels by depression status
ggplot(data = analysis_data %>% filter(!is.na(depression_binary))) +
  geom_boxplot(aes(x = depression_binary, y = LBXVIDMS, fill = depression_binary)) +
  theme_bw() + 
  xlab("Depression Status (PHQ-9 ≥ 10)") + 
  ylab("Serum 25(OH)D (nmol/L)") +
  ggtitle("Distribution of Vitamin D Levels by Depression Status") +
  scale_fill_manual(values = c("#4DAF4A", "#E41A1C")) +
  theme(legend.position = "none")
```

# 7. Complete case analysis

```{r}
# Dataset with complete cases
# Exclude missing values for key variables
analysis_complete <- analysis_data %>%
  filter(
    !is.na(LBXVIDMS),           # Vitamin D
    !is.na(depression_binary),  # Depression outcome
    !is.na(RIDAGEYR),           # Age
    !is.na(sex),                # Sex
    !is.na(race_ethnicity),     # Race/ethnicity
    !is.na(BMXBMI),             # BMI
    !is.na(education),          # Education
    !is.na(INDFMPIR),           # Income-to-poverty ratio
    !is.na(smoking_status)      # Smoking status
  )

# Calculate percentage of data dropped
n_original <- nrow(analysis_data)
n_complete <- nrow(analysis_complete)
n_dropped <- n_original - n_complete
pct_dropped <- (1 - n_complete/n_original) * 100

cat("Original sample size:", n_original, "\n")
cat("Complete case sample size:", n_complete, "\n")
cat("Number of observations dropped:", n_dropped, "\n")
cat("Percentage of data dropped:", round(pct_dropped, 2), "%\n")
```

# 8. Test linearity assumption for continuous predictors

```{r}
# Testing linearity assumption for Vitamin D using Box-Tidwell technique
analysis_complete$vitd_times_log_vitd <- analysis_complete$LBXVIDMS * log(analysis_complete$LBXVIDMS)

model_linearity_vitd <- glm(
  depression_binary ~ LBXVIDMS + vitd_times_log_vitd, 
  data = analysis_complete, 
  family = "binomial"
)

summary(model_linearity_vitd)

# Testing linearity assumption for Age
analysis_complete$age_times_log_age <- analysis_complete$RIDAGEYR * log(analysis_complete$RIDAGEYR)

model_linearity_age <- glm(
  depression_binary ~ RIDAGEYR + age_times_log_age,
  data = analysis_complete,
  family = "binomial"
)

summary(model_linearity_age)

# Testing linearity assumption for BMI
analysis_complete$bmi_times_log_bmi <- analysis_complete$BMXBMI * log(analysis_complete$BMXBMI)

model_linearity_bmi <- glm(
  depression_binary ~ BMXBMI + bmi_times_log_bmi,
  data = analysis_complete,
  family = "binomial"
)

summary(model_linearity_bmi)
```

# Box–Tidwell tests indicated non-linearity for vitamin D and BMI but not for age, so I will model vitamin D and BMI using categorical variables while keeping age as a continuous predictor.

#Change BMI into categorical
```{r}
analysis_complete <- analysis_complete %>%
  mutate(
    bmi_cat = case_when(
      BMXBMI < 25                 ~ "Normal/Underweight",
      BMXBMI >= 25 & BMXBMI < 30  ~ "Overweight",
      BMXBMI >= 30                ~ "Obese",
      TRUE ~ NA_character_
    ),
    bmi_cat = factor(bmi_cat,
                     levels = c("Normal/Underweight", "Overweight", "Obese"))
  )

```

# 9. Univariate logistic regression: Vitamin D and Depression

```{r}
# 9. Univariate logistic regression: Vitamin D category and Depression

# Ensure reference group is "Sufficient"
analysis_complete$vitd_category <- relevel(analysis_complete$vitd_category,
                                           ref = "Sufficient")

# Univariate model: Vitamin D categories predicting depression
model_unadjusted <- glm(
  depression_binary ~ vitd_category,
  data  = analysis_complete,
  family = "binomial"
)

# Model summary
summary(model_unadjusted)

# Odds ratios and 95% CIs
odds.n.ends(model_unadjusted)
```

#Compared with participants with sufficient vitamin D:

# Those with insufficient vitamin D have 46% higher odds of depression (OR = 1.46, 95% CI: 1.18–1.80, p < 0.001).

# Those with deficient vitamin D have about 81% higher odds of depression (OR = 1.81, 95% CI: 1.44–2.27, p < 0.001).



# 10. Multivariate logistic regression: Adjusted model

```{r}
# Multivariate model adjusting for age, sex, race/ethnicity, BMI, education, SES, and smoking
model_adjusted <- glm(
  depression_binary ~ vitd_category + RIDAGEYR + sex + race_ethnicity + 
                      bmi_cat + education + INDFMPIR + smoking_status,
  data = analysis_complete,
  family = "binomial"
)

# Get ORs and 95% CIs
odds.n.ends(model_adjusted)
```

# 11. Check for multicollinearity

```{r}
# Calculate VIF
vif_values <- car::vif(model_adjusted)
print(vif_values)

```

# 12. Influential observations using Cook's Distance

```{r}
# Plot Cook's Distance to identify influential observations
plot(model_adjusted, which = 4, id.n = 5, col = "red")

# Reference line at Cook's D = 1
abline(h = 1, lty = 2, col = "blue")
```


# 13. Model Performance Evaluation

```{r}
# Evaluate model fit with predicted probabilities, ROC curve, and AUC
odds.n.ends(model_adjusted, predProbPlot = TRUE, rocPlot = TRUE)
```

# 14. Descriptive Table 1

```{r}
library(htmltools)
library(rmarkdown)
# Create Table 1: Descriptive statistics by depression status
t1 <- table1::table1(
  ~ LBXVIDMS + vitd_category + RIDAGEYR + sex + race_ethnicity + 
    bmi_cat + education + INDFMPIR + smoking_status | depression_binary,
  data = analysis_complete,
  caption = "Descriptive Statistics by Depression Status (PHQ-9 ≥ 10)"
)
save_html(t1, file = "Table1.html")
pandoc_convert("Table1.html", to = "docx", output = "Table1.docx")
```

